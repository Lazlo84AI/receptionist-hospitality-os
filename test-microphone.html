<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Microphone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .recording {
            background: #f44336 !important;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        #log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            height: 300px;
            overflow-y: scroll;
            margin-top: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Microphone - V√©rification R√©elle</h1>
        
        <div id="status" class="status info">
            Cliquez sur "D√©marrer Test" pour v√©rifier l'acc√®s microphone
        </div>
        
        <button id="startTest" onclick="startMicrophoneTest()">D√©marrer Test</button>
        <button id="record" onclick="startRecording()" disabled>Enregistrer</button>
        <button id="stop" onclick="stopRecording()" disabled>Arr√™ter</button>
        <button id="play" onclick="playRecording()" disabled>√âcouter</button>
        
        <div id="log"></div>
        
        <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let stream;
        let recordedBlob;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        async function startMicrophoneTest() {
            log('D√©but du test microphone...');
            updateStatus('Demande d\'acc√®s au microphone...', 'info');
            
            try {
                // Cette ligne va d√©clencher la vraie popup de permission
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                log('‚úÖ SUCC√àS: Acc√®s microphone accord√©');
                updateStatus('Microphone accessible! Vous pouvez maintenant enregistrer.', 'success');
                
                // Afficher les infos du stream
                const tracks = stream.getAudioTracks();
                if (tracks.length > 0) {
                    const track = tracks[0];
                    log(`üìä Microphone d√©tect√©: ${track.label || 'Dispositif audio'}`);
                    log(`üéõÔ∏è Param√®tres: ${JSON.stringify(track.getSettings())}`);
                }
                
                // Activer le bouton d'enregistrement
                document.getElementById('record').disabled = false;
                document.getElementById('startTest').disabled = true;
                
            } catch (error) {
                log(`‚ùå ERREUR: ${error.name} - ${error.message}`);
                
                if (error.name === 'NotAllowedError') {
                    updateStatus('Permission microphone refus√©e par l\'utilisateur', 'error');
                } else if (error.name === 'NotFoundError') {
                    updateStatus('Aucun microphone trouv√© sur ce syst√®me', 'error');
                } else if (error.name === 'NotSupportedError') {
                    updateStatus('Microphone non support√© par ce navigateur', 'error');
                } else {
                    updateStatus(`Erreur microphone: ${error.message}`, 'error');
                }
            }
        }

        function startRecording() {
            if (!stream) {
                log('‚ùå Aucun stream audio disponible');
                return;
            }

            try {
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/wav'
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        log(`üì¶ Chunk re√ßu: ${event.data.size} bytes`);
                    }
                };

                mediaRecorder.onstop = () => {
                    recordedBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    log(`üéµ Enregistrement termin√©: ${recordedBlob.size} bytes`);
                    
                    if (recordedBlob.size > 0) {
                        updateStatus(`Enregistrement r√©ussi! Taille: ${recordedBlob.size} bytes`, 'success');
                        document.getElementById('play').disabled = false;
                    } else {
                        updateStatus('Enregistrement vide - aucune donn√©e captur√©e', 'error');
                    }
                    
                    document.getElementById('record').disabled = false;
                    document.getElementById('stop').disabled = true;
                    document.getElementById('record').classList.remove('recording');
                };

                mediaRecorder.onerror = (event) => {
                    log(`‚ùå Erreur MediaRecorder: ${event.error}`);
                };

                mediaRecorder.start(1000); // Chunks de 1 seconde
                log('üî¥ Enregistrement d√©marr√©...');
                updateStatus('Enregistrement en cours...', 'info');
                
                document.getElementById('record').disabled = true;
                document.getElementById('stop').disabled = false;
                document.getElementById('record').classList.add('recording');

            } catch (error) {
                log(`‚ùå Erreur lors du d√©marrage: ${error.message}`);
                updateStatus(`Erreur: ${error.message}`, 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                log('‚èπÔ∏è Arr√™t de l\'enregistrement...');
            }
        }

        function playRecording() {
            if (recordedBlob) {
                const audioUrl = URL.createObjectURL(recordedBlob);
                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                audioPlayer.play();
                log('‚ñ∂Ô∏è Lecture de l\'enregistrement');
            }
        }

        // Log des capacit√©s du navigateur au chargement
        window.onload = function() {
            log('=== Test des capacit√©s audio ===');
            log(`Navigator.mediaDevices: ${!!navigator.mediaDevices}`);
            log(`getUserMedia: ${!!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)}`);
            log(`MediaRecorder: ${!!window.MediaRecorder}`);
            
            if (window.MediaRecorder) {
                const types = ['audio/webm', 'audio/wav', 'audio/ogg', 'audio/mp4'];
                types.forEach(type => {
                    log(`Support ${type}: ${MediaRecorder.isTypeSupported(type)}`);
                });
            }
            log('========================');
        };
    </script>
</body>
</html>